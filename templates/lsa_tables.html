{% extends "base.html" %}

{% block title %}LSA Tabulky{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üìã LSA Tabulky</h1>
        <div>
            <a href="/beta" class="btn btn-secondary">
                ‚Üê Zpƒõt na hlavn√≠ str√°nku
            </a>
        </div>
    </div>

    <!-- Upload nov√© LSA tabulky -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üì§ Nahr√°t novou LSA tabulku</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('upload_lsa_table') }}" enctype="multipart/form-data" class="row g-3">
                <div class="col-md-6">
                    <label for="file" class="form-label">Excel nebo CSV soubor</label>
                    <input type="file" class="form-control" id="file" name="file" 
                           accept=".xlsx,.xls,.csv" required>
                    <div class="form-text">
                        Podporovan√© form√°ty: .xlsx, .xls, .csv<br>
                        Mus√≠ obsahovat sloupce: A (datum), B (LSA oznaƒçen√≠), C (LSA k√≥d), D (text palety), E (poƒçet palet)
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="table_name" class="form-label">N√°zev tabulky (voliteln√©)</label>
                    <input type="text" class="form-control" id="table_name" name="table_name" 
                           placeholder="Pokud nevypln√≠te, pou≈æije se n√°zev souboru">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Nahr√°t</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Seznam LSA tabulek -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">üìö Dostupn√© LSA tabulky</h5>
        </div>
        <div class="card-body">
            {% if tables %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>N√°zev</th>
                                <th>P≈Øvodn√≠ soubor</th>
                                <th>Poƒçet LSA</th>
                                <th>Vytvo≈ôeno</th>
                                <th>Akce</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for table in tables %}
                            <tr>
                                <td>
                                    <strong>{{ table.name }}</strong>
                                </td>
                                <td>
                                    <small class="text-muted">{{ table.filename }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ table.rows_count }} LSA</span>
                                </td>
                                <td>
                                    <small>{{ table.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-info view-lsa-table-btn" 
                                                data-table-id="{{ table.id }}"
                                                title="Zobrazit obsah">
                                            üëÅÔ∏è Zobrazit
                                        </button>
                                        <button type="button" class="btn btn-outline-danger delete-lsa-table-btn" 
                                                data-table-id="{{ table.id }}" 
                                                data-table-name="{{ table.name }}"
                                                title="Smazat tabulku">
                                            üóëÔ∏è Smazat
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fa fa-table fa-3x mb-3"></i>
                    <p>Zat√≠m nem√°te ≈æ√°dn√© LSA tabulky.</p>
                    <p>Nahrajte Excel nebo CSV soubor s LSA daty.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal pro zobrazen√≠ obsahu LSA tabulky -->
<div class="modal fade" id="lsaTableModal" tabindex="-1" aria-labelledby="lsaTableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lsaTableModalLabel">üìã Obsah LSA tabulky</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="lsaTableContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Naƒç√≠t√°m...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zav≈ô√≠t</button>
            </div>
        </div>
    </div>
</div>

<script>
// Event listenery pro tlaƒç√≠tka
document.addEventListener('DOMContentLoaded', function() {
    // View tlaƒç√≠tka
    document.querySelectorAll('.view-lsa-table-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tableId = this.dataset.tableId;
            viewLSATable(parseInt(tableId));
        });
    });
    
    // Delete tlaƒç√≠tka
    document.querySelectorAll('.delete-lsa-table-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tableId = this.dataset.tableId;
            const tableName = this.dataset.tableName;
            deleteLSATable(parseInt(tableId), tableName);
        });
    });
});

function viewLSATable(tableId) {
    // Otev≈ôi modal
    const modal = new bootstrap.Modal(document.getElementById('lsaTableModal'));
    modal.show();
    
    // Naƒçti obsah tabulky
    fetch(`/get_lsa_table/${tableId}`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('lsaTableContent');
            
            if (data.items && data.items.length > 0) {
                let html = `
                    <div class="mb-3">
                        <h6>${data.table.name}</h6>
                        <small class="text-muted">Vytvo≈ôeno: ${new Date(data.table.created_at).toLocaleString('cs-CZ')}</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>LSA oznaƒçen√≠</th>
                                    <th>LSA k√≥d</th>
                                    <th>Text palety</th>
                                    <th>Poƒçet palet</th>
                                    <th>D√©lka (m)</th>
                                    <th>Pou≈æito v zak√°zk√°ch</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.items.forEach(item => {
                    const usageInfo = item.used_in_orders && item.used_in_orders.length > 0 
                        ? `<span class="badge bg-success">${item.used_in_orders.length}√ó</span>`
                        : '<span class="badge bg-secondary">Nepou≈æito</span>';
                    
                    html += `
                        <tr>
                            <td>${item.date_received || ''}</td>
                            <td>${item.lsa_designation || ''}</td>
                            <td><strong>${item.lsa || ''}</strong></td>
                            <td>${item.pallet_text || ''}</td>
                            <td class="text-center"><span class="badge bg-primary">${item.qty || 1}</span></td>
                            <td class="text-end">${item.length_m ? item.length_m.toFixed(2) : '0.00'}</td>
                            <td>${usageInfo}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                content.innerHTML = html;
            } else {
                content.innerHTML = '<div class="alert alert-warning">Tabulka neobsahuje ≈æ√°dn√° data.</div>';
            }
        })
        .catch(error => {
            console.error('Chyba p≈ôi naƒç√≠t√°n√≠ tabulky:', error);
            document.getElementById('lsaTableContent').innerHTML = 
                '<div class="alert alert-danger">Chyba p≈ôi naƒç√≠t√°n√≠ obsahu tabulky.</div>';
        });
}

function deleteLSATable(tableId, tableName) {
    if (confirm(`Opravdu chcete smazat LSA tabulku "${tableName}"?\n\nTato akce je nevratn√°!`)) {
        // Vytvo≈ô skryt√Ω formul√°≈ô pro POST request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_lsa_table/${tableId}`;
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}