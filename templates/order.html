{% extends 'base.html' %}
{% block content %}
  <div class="d-flex justify-content-between mb-3">
    <div>
      <form method="post" action="{{ url_for('edit_order_name', order_id=order.id) }}" class="d-inline-flex align-items-center">
        <h2 class="me-2">Zak√°zka:</h2>
        <input type="text" name="order_name" value="{{ order.name }}" class="form-control me-2" style="width: 300px;" />
        <button type="submit" class="btn btn-sm btn-outline-secondary">Ulo≈æit jm√©no</button>
      </form>
      {% if order.closed %}<span class="badge bg-success ms-2">Closed</span>{% endif %}
      {% if order.saved_for_later %}<span class="badge bg-info ms-2">Ulo≈æeno na pozdƒõji</span>{% endif %}
    </div>
    <div>
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('upload', order_id=order.id) }}">Import .xlsx</a>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('export_order', order_id=order.id) }}">Export CSV</a>
      {% if not order.closed and not order.saved_for_later %}
      <form method="post" action="{{ url_for('save_for_later', order_id=order.id) }}" class="d-inline">
        <button type="submit" class="btn btn-sm btn-outline-warning">Ulo≈æit na pozdƒõji</button>
      </form>
      {% endif %}
      {% if order.closed %}
      <a class="btn btn-sm btn-outline-info" href="{{ url_for('print_order', order_id=order.id) }}" target="_blank">Tisk</a>
      {% endif %}
      {% if not order.closed and order.items|length == 0 %}
      <!-- Tlaƒç√≠tko pro smaz√°n√≠ pr√°zdn√© zak√°zky -->
      <button type="button" class="btn btn-sm btn-outline-danger" 
              onclick="deleteCurrentOrder(this.dataset.orderId, this.dataset.orderName)" 
              data-order-id="{{ order.id }}" 
              data-order-name="{{ order.name }}"
              title="Smazat pr√°zdnou zak√°zku">
        üóëÔ∏è Smazat pr√°zdnou zak√°zku
      </button>
      {% endif %}
    </div>
  </div>

  {% if order.imported_files %}
  <div class="alert alert-info">
    <strong>Importovan√© soubory:</strong>
    {% for file in order.imported_files %}
      {{ file.filename }} ({{ file.rows_imported }} palet, {{ file.uploaded_at.strftime('%d.%m.%Y %H:%M') }}){% if not loop.last %}, {% endif %}
    {% endfor %}
  </div>
  {% endif %}

  {% if not order.closed %}
  <!-- Import dostupn√Ωch LSA -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6>üì• Import dostupn√Ωch LSA z jin√Ωch zak√°zek</h6>
      <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadAvailableLSA(this.dataset.orderId)" id="loadAvailableLSABtn" data-order-id="{{ order.id }}">
        üîç Zobrazit dostupn√© LSA
      </button>
    </div>
    <div class="card-body" id="availableLSAContainer" style="display: none;">
      <div class="row">
        <div class="col-md-8">
          <div class="mb-3">
            <input type="text" class="form-control" id="lsaSearchInput" placeholder="üîç Vyhledat LSA podle ƒç√≠sla, oznaƒçen√≠ nebo textu..." onkeyup="filterAvailableLSA()">
          </div>
          
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-striped" id="availableLSATable">
              <thead class="table-light sticky-top">
                <tr>
                  <th>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="selectAllAvailableLSA" onchange="toggleSelectAllAvailable()">
                      <label class="form-check-label" for="selectAllAvailableLSA">V≈°e</label>
                    </div>
                  </th>
                  <th>LSA Nr.</th>
                  <th>Oznaƒçen√≠</th>
                  <th>Rozmƒõry</th>
                  <th>Poƒçet</th>
                  <th>V√°ha (kg)</th>
                  <th>Zdroj</th>
                </tr>
              </thead>
              <tbody id="availableLSATableBody">
                <!-- Data naƒçtena dynamicky p≈ôes AJAX -->
              </tbody>
            </table>
          </div>
          
          <div id="noAvailableLSA" style="display: none;" class="text-center text-muted py-4">
            <i class="fas fa-box-open"></i><br>
            ≈Ω√°dn√© dostupn√© LSA nenalezeny
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h6>üìä Souhrn v√Ωbƒõru</h6>
            </div>
            <div class="card-body">
              <div class="mb-2">
                <strong>Vybran√© LSA:</strong> <span id="selectedLSACount">0</span>
              </div>
              <div class="mb-2">
                <strong>Celkem palet:</strong> <span id="selectedPalletCount">0</span>
              </div>
              <div class="mb-3">
                <strong>Celkov√° v√°ha:</strong> <span id="selectedTotalWeight">0</span> kg
              </div>
              
              <button type="button" class="btn btn-success w-100" onclick="importSelectedLSA(this.dataset.orderId)" id="importLSABtn" data-order-id="{{ order.id }}" disabled>
                üì• Importovat vybran√© LSA
              </button>
              
              <div class="mt-3">
                <small class="text-muted">
                  üí° <strong>Tip:</strong> M≈Ø≈æete importovat LSA z:
                  <br>‚Ä¢ Zak√°zek ulo≈æen√Ωch na pozdƒõji
                  <br>‚Ä¢ Nep≈ôi≈ôazen√Ωch palet z jin√Ωch zak√°zek
                  <br>‚Ä¢ Vy≈ôazen√Ωch z nakl√°dky
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <div class="row">
    <div class="col-md-7">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Palety v zak√°zce</h4>
        <form style="display:inline" action="{{ url_for('auto_assign_route', order_id=order.id) }}" method="post">
          <button type="submit" class="btn btn-sm btn-outline-success">üöõ Auto p≈ôi≈ôadit + optimalizovat lanes</button>
        </form>
      </div>
      <table class="table table-sm">
        <thead><tr><th>Datum</th><th>Oznaƒçen√≠</th><th>LSA</th><th>Text</th><th>len(m)</th><th>V√°ha(kg)</th><th>Lane</th></tr></thead>
        <tbody>
          {% for it in order.items|sort(attribute='import_order') %}
            <tr class="{% if it.assigned_lane == 1 %}table-primary{% elif it.assigned_lane == 2 %}table-info{% elif it.assigned_lane == 3 %}table-warning{% endif %}">
              <td><small>{{ it.date_received or '' }}</small></td>
              <td><small>{{ it.lsa_designation or '' }}</small></td>
              <td>{{ it.lsa }}</td>
              <td style="max-width:200px">{{ it.pallet_text }}</td>
              <td>{{ '%.2f'|format(it.length_m) }}</td>
              <td><small>{{ '%.1f'|format(it.weight) }}</small></td>
              <td>
                {% if it.assigned_lane %}
                  <span class="badge bg-secondary">Lane {{ it.assigned_lane }}</span>
                {% else %}
                  <span class="text-muted">neza≈ôazeno</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="col-md-5">
      <h4>Lane p≈ôehled</h4>
      
      <!-- Celkov√Ω p≈ôehled kapacity -->
      {% set total_pallet_places = pallet_places %}
      {% set max_pallet_capacity = 33 %}
      {% set capacity_percentage = (total_pallet_places / max_pallet_capacity * 100)|round(1) %}
      {% set is_overloaded = total_pallet_places > max_pallet_capacity %}
      
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong>Paletov√° m√≠sta: {{ '%.1f'|format(total_pallet_places) }} / {{ max_pallet_capacity }} m√≠st</strong>
          <span class="badge {{ 'bg-danger' if is_overloaded else 'bg-success' if capacity_percentage > 90 else 'bg-warning' if capacity_percentage > 75 else 'bg-primary' }}">
            {{ capacity_percentage }}%
          </span>
        </div>
        
        <!-- Vizu√°ln√≠ indik√°tor kapacity - obd√©ln√≠k kamion -->
        <div class="border rounded p-2 bg-light capacity-truck-container">
          <div class="capacity-fill-bar" 
               data-percentage="{{ [capacity_percentage, 100]|min }}"
               data-is-overloaded="{{ 'true' if is_overloaded else 'false' }}"
               data-capacity-state="{{ 'danger' if is_overloaded else 'success' if capacity_percentage <= 100 else 'warning' }}">
          </div>
          {% if is_overloaded %}
            <div class="capacity-overflow-bar" 
                 data-overflow-width="{{ capacity_percentage - 100 }}">
            </div>
          {% endif %}
        </div>
        
        <style>
          .capacity-truck-container {
            position: relative;
            height: 40px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
          }
          .capacity-fill-bar {
            height: 100%;
            border-radius: 0.375rem;
            transition: width 0.3s ease;
          }
          .capacity-fill-bar[data-capacity-state="success"] {
            background-color: #198754;
          }
          .capacity-fill-bar[data-capacity-state="warning"] {
            background-color: #ffc107;
          }
          .capacity-fill-bar[data-capacity-state="danger"] {
            background-color: #dc3545;
          }
          .capacity-overflow-bar {
            height: 100%;
            background-color: #dc3545;
            opacity: 0.75;
            position: absolute;
            top: 2px;
            left: 2px;
            border-radius: 0.375rem;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,.3) 5px, rgba(255,255,255,.3) 10px);
          }
        </style>
        
        <script>
          // Set width based on data attributes
          document.addEventListener('DOMContentLoaded', function() {
            const fillBar = document.querySelector('.capacity-fill-bar');
            if (fillBar) {
              const percentage = fillBar.getAttribute('data-percentage');
              fillBar.style.width = percentage + '%';
            }
            
            const overflowBar = document.querySelector('.capacity-overflow-bar');
            if (overflowBar) {
              const overflowWidth = overflowBar.getAttribute('data-overflow-width');
              overflowBar.style.width = overflowWidth + '%';
            }
          });
        </script>
        <small class="text-muted">üöõ Vizualizace n√°kladu vozidla (33 paletov√Ωch m√≠st na 13,6m kamion)</small>
        
        {% if is_overloaded %}
        <div class="alert alert-danger mt-2 py-2">
          <i class="fas fa-exclamation-triangle"></i> <strong>Varov√°n√≠!</strong> 
          P≈ôekroƒçena kapacita vozidla o {{ '%.1f'|format(total_pallet_places - max_pallet_capacity) }} paletov√Ωch m√≠st!
        </div>
        {% endif %}
      </div>
      
      <div class="lane-summary lane-1">
        <h5>Lane 1 <small class="text-muted">(modr√°)</small></h5>
        <p class="mb-1"><strong>{{ '%.2f'|format(lane_totals[1]) }} m</strong></p>
        <small>{{ order.items|selectattr('assigned_lane', 'equalto', 1)|list|length }} palet</small>
      </div>
      
      <div class="lane-summary lane-2">
        <h5>Lane 2 <small class="text-muted">(svƒõtle modr√°)</small></h5>
        <p class="mb-1"><strong>{{ '%.2f'|format(lane_totals[2]) }} m</strong></p>
        <small>{{ order.items|selectattr('assigned_lane', 'equalto', 2)|list|length }} palet</small>
      </div>
      
      <div class="lane-summary lane-3">
        <h5>Lane 3 <small class="text-muted">(≈ælut√°)</small></h5>
        <p class="mb-1"><strong>{{ '%.2f'|format(lane_totals[3]) }} m</strong></p>
        <small>{{ order.items|selectattr('assigned_lane', 'equalto', 3)|list|length }} palet</small>
      </div>
      <hr />
      <p>Souƒçet v≈°ech lane: {{ '%.2f'|format(lane_totals[1]+lane_totals[2]+lane_totals[3]) }} m</p>
      <p>Celkov√° v√°ha: <strong>{{ '%.1f'|format(total_weight) }} kg</strong></p>
      <p>Paletov√Ωch m√≠st ({{ '%.2f'|format(pallet_places) }}): <strong>{{ price }} Kƒç</strong> {% if is_full %}<span class="badge bg-warning">Full truck</span>{% endif %}</p>

      <!-- Vizualizace n√°kladu kami√≥nu -->
      <div class="mt-4">
        <h4>üöõ Vizualizace n√°kladu <small class="text-muted">(drag & drop pro p≈ôeskl√°d√°n√≠)</small></h4>
        
        <div id="truck-visualization" class="border rounded p-3 bg-light" style="max-width: 650px; margin: 0 auto;">
          <div class="truck-layout">
            <!-- Hlaviƒçky lanes -->
            <div class="lane-headers">
              <div class="lane-header">
                <span class="badge bg-primary">Lane 1</span>
                <div class="lane-total">{{ '%.1f'|format(lane_totals[1]) }} m</div>
              </div>
              <div class="lane-header">
                <span class="badge bg-info">Lane 2</span>
                <div class="lane-total">{{ '%.1f'|format(lane_totals[2]) }} m</div>
              </div>
              <div class="lane-header">
                <span class="badge bg-warning">Lane 3</span>
                <div class="lane-total">{{ '%.1f'|format(lane_totals[3]) }} m</div>
              </div>
            </div>

            <!-- Lanes s paletami -->
            <div class="truck-lanes">
              <!-- Lane 1 -->
              <div class="truck-lane" data-lane="1" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="drop-zone top" data-lane="1" data-position="0" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% for item in order.items|selectattr('assigned_lane', 'equalto', 1)|sort(attribute='import_order') %}
                <div class="pallet-box" draggable="true" ondragstart="drag(event)" data-item-id="{{ item.id }}" data-lsa="{{ item.lsa }}">
                  <div class="pallet-length">{{ '%.1f'|format(item.length_m) }}</div>
                  <div class="pallet-lsa" data-lsa="{{ item.lsa }}">{{ item.lsa }}</div>
                </div>
                <div class="drop-zone" data-lane="1" data-position="{{ loop.index }}" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% endfor %}
                {% if not order.items|selectattr('assigned_lane', 'equalto', 1)|list %}
                <div class="drop-zone bottom" data-lane="1" data-position="0" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% endif %}
              </div>

              <!-- Lane 2 -->
              <div class="truck-lane" data-lane="2" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="drop-zone top" data-lane="2" data-position="0" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% for item in order.items|selectattr('assigned_lane', 'equalto', 2)|sort(attribute='import_order') %}
                <div class="pallet-box" draggable="true" ondragstart="drag(event)" data-item-id="{{ item.id }}" data-lsa="{{ item.lsa }}">
                  <div class="pallet-length">{{ '%.1f'|format(item.length_m) }}</div>
                  <div class="pallet-lsa" data-lsa="{{ item.lsa }}">{{ item.lsa }}</div>
                </div>
                <div class="drop-zone" data-lane="2" data-position="{{ loop.index }}" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% endfor %}
                {% if not order.items|selectattr('assigned_lane', 'equalto', 2)|list %}
                <div class="drop-zone bottom" data-lane="2" data-position="0" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% endif %}
              </div>

              <!-- Lane 3 -->
              <div class="truck-lane" data-lane="3" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="drop-zone top" data-lane="3" data-position="0" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% for item in order.items|selectattr('assigned_lane', 'equalto', 3)|sort(attribute='import_order') %}
                <div class="pallet-box" draggable="true" ondragstart="drag(event)" data-item-id="{{ item.id }}" data-lsa="{{ item.lsa }}">
                  <div class="pallet-length">{{ '%.1f'|format(item.length_m) }}</div>
                  <div class="pallet-lsa" data-lsa="{{ item.lsa }}">{{ item.lsa }}</div>
                </div>
                <div class="drop-zone" data-lane="3" data-position="{{ loop.index }}" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% endfor %}
                {% if not order.items|selectattr('assigned_lane', 'equalto', 3)|list %}
                <div class="drop-zone bottom" data-lane="3" data-position="0" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% endif %}
              </div>
            </div>

            <!-- Nep≈ôi≈ôazen√© palety -->
            {% if order.items|selectattr('assigned_lane', 'equalto', 0)|list %}
            <div class="unassigned-section mt-3">
              <div class="lane-header">
                <span class="badge bg-secondary">Nep≈ôi≈ôazen√©</span>
              </div>
              <div class="truck-lane unassigned" data-lane="0" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="drop-zone top" data-lane="0" data-position="0" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% for item in order.items|selectattr('assigned_lane', 'equalto', 0)|sort(attribute='import_order') %}
                <div class="pallet-box" draggable="true" ondragstart="drag(event)" data-item-id="{{ item.id }}" data-lsa="{{ item.lsa }}">
                  <div class="pallet-length">{{ '%.1f'|format(item.length_m) }}</div>
                  <div class="pallet-lsa" data-lsa="{{ item.lsa }}">{{ item.lsa }}</div>
                </div>
                <div class="drop-zone" data-lane="0" data-position="{{ loop.index }}" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% endfor %}
                {% if not order.items|selectattr('assigned_lane', 'equalto', 0)|list %}
                <div class="drop-zone bottom" data-lane="0" data-position="0" ondrop="dropAtPosition(event)" ondragover="allowDrop(event)"></div>
                {% endif %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

    </div>
  </div>

  {% if not order.closed %}
      <h5>Uzav≈ô√≠t zak√°zku</h5>
      <form method="post" action="{{ url_for('close_order') }}">
        <input type="hidden" name="order_id" value="{{ order.id }}" />
        
        <div class="mb-3">
          <label class="form-label">Jm√©no dopravce</label>
          <input type="text" name="carrier_name" class="form-control" placeholder="nap≈ô. Ji≈ô√≠ Nov√°k" required />
        </div>
        
        <div class="mb-3">
          <label class="form-label">Email dopravce</label>
          <input type="email" name="carrier_email" class="form-control" placeholder="dopravce@example.com" />
        </div>
        
        <div class="mb-3">
          <label class="form-label">Datum a ƒças nakl√°dky</label>
          <input type="datetime-local" name="pickup_datetime" class="form-control" required />
        </div>
        
        <div class="mb-3">
          <label class="form-label">Pozn√°vac√≠ znaƒçka kamionu</label>
          <input type="text" name="truck_license_plate" class="form-control" placeholder="nap≈ô. 1A2 3456" required />
        </div>
        
        <div class="mb-3">
          <label class="form-label">Email adresy pro nakl√°dku <small class="text-muted">(oddƒõlen√© ƒç√°rkami)</small></label>
          <input type="text" name="loading_emails" class="form-control" placeholder="loading1@bad-zwischenahn.com, loading2@bad-zwischenahn.com" />
        </div>
        
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success">Uzav≈ô√≠t zak√°zku</button>
        </div>
      </form>
      
      <form method="post" action="{{ url_for('save_for_later', order_id=order.id) }}" class="mt-3">
        <button type="submit" class="btn btn-outline-warning">Ulo≈æit na pozdƒõji</button>
      </form>
      {% else %}
      <div class="alert alert-success">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5>Zak√°zka uzav≈ôena</h5>
            <p><strong>Dopravce:</strong> {{ order.carrier_name or 'neuvedeno' }}</p>
            <p><strong>Email dopravce:</strong> {{ order.carrier_email or 'neuvedeno' }}</p>
            <p><strong>Nakl√°dka:</strong> {{ order.pickup_datetime.strftime('%d.%m.%Y %H:%M') if order.pickup_datetime else 'neuvedeno' }}</p>
            <p><strong>Kamion:</strong> {{ order.truck_license_plate or 'neuvedeno' }}</p>
            {% if order.loading_emails %}
              {% set loading_emails_list = order.loading_emails|from_json %}
              <p><strong>Email adresy nakl√°dky:</strong> {{ loading_emails_list|join(', ') }}</p>
            {% endif %}
            {% if order.user_email %}
              <p><strong>Reply-To email:</strong> {{ order.user_email }}</p>
            {% endif %}
          </div>
          <div class="ms-3">
            <!-- Tlaƒç√≠tko pro znovu otev≈ôen√≠ zak√°zky -->
            <div class="dropdown">
              <button class="btn btn-outline-warning dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                üîÑ Znovu otev≈ô√≠t zak√°zku
              </button>
              <ul class="dropdown-menu">
                <li>
                  <form method="post" action="{{ url_for('reopen_order', order_id=order.id) }}" class="dropdown-item-form">
                    <button type="submit" class="dropdown-item" onclick="return confirm('Opravdu chcete znovu otev≈ô√≠t tuto zak√°zku? Zachovaj√≠ se v≈°echny √∫daje dopravce.')">
                      üîÑ Znovu otev≈ô√≠t (zachovat √∫daje)
                    </button>
                  </form>
                </li>
                <li>
                  <form method="post" action="{{ url_for('reopen_order', order_id=order.id) }}" class="dropdown-item-form">
                    <input type="hidden" name="clear_carrier_info" value="on">
                    <button type="submit" class="dropdown-item text-warning" onclick="return confirm('Opravdu chcete znovu otev≈ô√≠t tuto zak√°zku a vymazat v≈°echny √∫daje dopravce?')">
                      üóëÔ∏è Znovu otev≈ô√≠t (vymazat dopravce)
                    </button>
                  </form>
                </li>
              </ul>
            </div>
            <small class="text-muted d-block mt-1">Pou≈æijte pokud dopravce zak√°zku zru≈°√≠</small>
          </div>
        </div>
      </div>
      
      <!-- Souhrnn√° tabulka LSA -->
      <div class="card mt-3" data-order-id="{{ order.id }}">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6>üìä Souhrn LSA k nakl√°dce</h6>
          <div id="loading-progress" class="progress" style="width: 200px; height: 20px; display: none;">
            <div class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-striped" id="lsa-summary-table">
              <thead class="table-light">
                <tr>
                  <th>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="selectAllLSA" title="Oznaƒçit/odznaƒçit v≈°echny LSA">
                      <label class="form-check-label" for="selectAllLSA">
                        Nalo≈æeno
                      </label>
                    </div>
                  </th>
                  <th>LSA Nr.</th>
                  <th>Pallet size</th>
                  <th>Poƒçet palet</th>
                  <th>Celkov√° v√°ha (kg)</th>
                  <th>Akce</th>
                </tr>
              </thead>
              <tbody>
                {% for lsa, data in lsa_summary.items() %}
                <tr data-lsa="{{ lsa }}" data-order-id="{{ order.id }}">
                  <td>
                    <div class="form-check">
                      <input class="form-check-input lsa-checkbox" type="checkbox" 
                             id="lsa-{{ lsa }}" 
                             data-lsa="{{ lsa }}" 
                             data-order-id="{{ order.id }}"
                             onchange="toggleLSALoaded(this.dataset.lsa, this.dataset.orderId, this.checked)">
                      <label class="form-check-label" for="lsa-{{ lsa }}">
                        <span class="loading-status" id="status-{{ lsa }}">
                          <span class="badge bg-secondary">Nezkontrolov√°no</span>
                        </span>
                      </label>
                    </div>
                  </td>
                  <td><strong>{{ lsa }}</strong></td>
                  <td>
                    {% for length, count in data['lengths'].items() %}
                      {% if count > 1 %}
                        {{ length }} ({{ count }}ks)
                      {% else %}
                        {{ length }}
                      {% endif %}
                      {% if not loop.last %}, {% endif %}
                    {% endfor %}
                  </td>
                  <td><span class="badge bg-primary">{{ data['count'] }}</span></td>
                  <td><strong>{{ "%.0f"|format(data['total_weight']) }}</strong></td>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            onclick="removeLSAFromOrder(this.closest('tr').dataset.lsa, this.closest('tr').dataset.orderId)" 
                            title="Odstranit cel√© LSA z nakl√°dky">
                      ‚ùå Odstranit
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <th colspan="3">Celkem</th>
                  <th>
                    {% set total_pallets = lsa_summary.values()|sum(attribute='count') %}
                    <span class="badge bg-success">{{ total_pallets }}</span>
                  </th>
                  <th>
                    {% set total_weight = lsa_summary.values()|sum(attribute='total_weight') %}
                    <strong>{{ "%.0f"|format(total_weight) }}</strong>
                  </th>
                  <th>
                    <button type="button" class="btn btn-sm btn-warning" 
                            onclick="returnUnloadedItems(this.closest('.card').dataset.orderId)" 
                            id="return-unloaded-btn"
                            title="Vr√°tit v≈°echny neoznaƒçen√© LSA zpƒõt do fronty">
                      ‚Ü©Ô∏è Vr√°tit nenalo≈æen√©
                    </button>
                  </th>
                </tr>
              </tfoot>
            </table>
          </div>
          
          <!-- Celkov√Ω p≈ôehled naƒç√≠t√°n√≠ -->
          <div class="mt-3 p-3 rounded" id="loading-overview" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
            <h6>üìã P≈ôehled nakl√°dky</h6>
            <div class="row">
              <div class="col-md-4">
                <div class="text-center">
                  <div class="h4 text-success mb-1" id="loaded-count">0</div>
                  <small style="color: var(--text-muted);">Nalo≈æen√© LSA</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <div class="h4 text-danger mb-1" id="pending-count">{{ lsa_summary|length }}</div>
                  <small style="color: var(--text-muted);">ƒåekaj√≠c√≠ LSA</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <div class="h4 text-primary mb-1" id="completion-percentage">0%</div>
                  <small style="color: var(--text-muted);">Dokonƒçeno</small>
                </div>
              </div>
            </div>
            
            <!-- Progress bar -->
            <div class="progress mt-3" style="height: 25px;">
              <div class="progress-bar bg-success progress-bar-striped" 
                   role="progressbar" 
                   style="width: 0%" 
                   id="overall-progress"
                   aria-valuenow="0" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
                0%
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Email funkce pro uzav≈ôen√© zak√°zky -->
      <div class="card mt-3">
        <div class="card-header">
          <h6>üìß Odes√≠l√°n√≠ email≈Ø</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Email pro dopravce</h6>
              <p class="small text-muted">P≈ôedmƒõt: K√≥dy k nakl√°dce ({{ order.pickup_datetime.strftime('%d.%m.%Y') if order.pickup_datetime else 'TBD' }})</p>
              {% if order.carrier_email and order.pickup_datetime %}
                <button type="button" class="btn btn-outline-primary btn-sm" data-action="send-carrier" data-order-id="{{ order.id }}">
                  üì© Odeslat dopravci
                </button>
              {% else %}
                <p class="text-muted small">Email dopravce nebo datum nakl√°dky nen√≠ vyplnƒõno</p>
              {% endif %}
            </div>
            <div class="col-md-6">
              <h6>Email pro nakl√°dku</h6>
              <p class="small text-muted">P≈ôedmƒõt: Aviso ({{ order.pickup_datetime.strftime('%d.%m.%Y') if order.pickup_datetime else 'TBD' }})</p>
              {% if order.pickup_datetime %}
                <div class="mb-2">
                  <label class="form-label small">Dodateƒçn√Ω text (nepovinn√©):</label>
                  <input type="text" id="additionalText" class="form-control form-control-sm" placeholder="Dodateƒçn√© informace...">
                </div>
                <button type="button" class="btn btn-outline-success btn-sm" data-action="send-loading" data-order-id="{{ order.id }}">
                  üìã Odeslat na nakl√°dku
                </button>
              {% else %}
                <p class="text-muted small">Datum nakl√°dky nen√≠ vyplnƒõno</p>
              {% endif %}
            </div>
          </div>
          
          <!-- Formul√°≈ô pro aktualizaci email adres -->
          <hr>
          <h6>Aktualizace email adres</h6>
          <form method="post" action="{{ url_for('update_order_emails', order_id=order.id) }}">
            <div class="row">
              <div class="col-md-4">
                <label class="form-label small">Email dopravce:</label>
                <input type="email" name="carrier_email" class="form-control form-control-sm" value="{{ order.carrier_email or '' }}" placeholder="dopravce@example.com">
              </div>
              <div class="col-md-4">
                <label class="form-label small">Email adresy nakl√°dky (oddƒõlen√© ƒç√°rkami):</label>
                <input type="text" name="loading_emails" class="form-control form-control-sm" 
                       value="{% if order.loading_emails %}{{ (order.loading_emails|from_json)|join(', ') }}{% endif %}" 
                       placeholder="loading1@example.com, loading2@example.com">
              </div>
              <div class="col-md-4">
                <label class="form-label small">V√°≈° email (Reply-To):</label>
                <input type="email" name="user_email" class="form-control form-control-sm" value="{{ order.user_email or '' }}" placeholder="vas.email@company.com">
                <small class="text-muted">P≈ô√≠jemci mohou odpovƒõdƒõt na tento email</small>
              </div>
            </div>
            <button type="submit" class="btn btn-sm btn-outline-secondary mt-2">Aktualizovat adresy</button>
          </form>
        </div>
      </div>
      
      <!-- Spr√°va n√°lo≈æen√≠ a ƒç√≠sel ZA/OO -->
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6>üöõ Spr√°va n√°lo≈æen√≠</h6>
          {% if order.is_loaded %}
            <span class="badge bg-success">Nalo≈æeno</span>
          {% else %}
            <span class="badge bg-secondary">ƒåek√° na nalo≈æen√≠</span>
          {% endif %}
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('update_loading_status', order_id=order.id) }}">
            <div class="row">
              <div class="col-md-3">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" name="is_loaded" id="isLoaded" 
                         {% if order.is_loaded %}checked{% endif %}>
                  <label class="form-check-label" for="isLoaded">
                    Oznaƒçit jako nalo≈æeno
                  </label>
                </div>
                {% if order.is_loaded %}
                <div class="form-check form-switch mt-2">
                  <input class="form-check-input" type="checkbox" name="delivered" id="delivered" 
                         {% if order.delivered %}checked{% endif %}>
                  <label class="form-check-label" for="delivered">
                    Oznaƒçit jako doruƒçeno
                  </label>
                </div>
                {% endif %}
              </div>
              <div class="col-md-3">
                <label class="form-label small">ZA ƒç√≠slo:</label>
                <input type="text" name="za_number" class="form-control form-control-sm" 
                       value="{{ order.za_number or '' }}" placeholder="ZA-10250">
              </div>
              <div class="col-md-3">
                <label class="form-label small">OO ƒç√≠slo:</label>
                <input type="text" name="oo_number" class="form-control form-control-sm" 
                       value="{{ order.oo_number or '' }}" placeholder="OO-11056">
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-sm btn-outline-primary">Aktualizovat</button>
              </div>
            </div>
          </form>
          
          <!-- Tiskov√Ω v√Ωstup -->
          {% if order.za_number or order.oo_number %}
          <hr>
          <div class="d-flex gap-2">
            <a href="{{ url_for('print_loading_sheet', order_id=order.id) }}" target="_blank" 
               class="btn btn-outline-info btn-sm">
              üñ®Ô∏è Tiskov√Ω v√Ωstup (A4)
            </a>
            {% if order.is_loaded %}
              <small class="text-success align-self-center">‚úÖ Zak√°zka oznaƒçena jako nalo≈æen√°</small>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <hr />
      <h5>Odstranit cel√© LSA</h5>
      <form method="post" action="{{ url_for('remove_lsa') }}">
        <input type="hidden" name="order_id" value="{{ order.id }}" />
        <div class="input-group">
          <select name="lsa" class="form-select">
            {% for l in order.items|map(attribute='lsa')|unique %}
              <option value="{{ l }}">{{ l }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-danger">Odstranit LSA</button>
        </div>
      </form>

    </div>
  </div>

<style>
/* Styly pro tabulkovou vizualizaci kamionu */
.truck-layout {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
  max-width: 600px;  /* Omezen√≠ ≈°√≠≈ôky pro kompaktnost */
  margin: 0 auto;    /* Centrov√°n√≠ */
}

.lane-headers {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 1px;
  background: var(--border-color);
  padding: 1px;
}

.lane-header {
  background: var(--card-bg);
  padding: 8px;      /* Zmen≈°eno z 10px */
  text-align: center;
  border-bottom: 2px solid var(--border-color);
  color: var(--text-color);
}

.lane-header .badge {
  display: block;
  margin-bottom: 5px;
  font-size: 0.8em;  /* Men≈°√≠ font */
}

.lane-total {
  font-weight: bold;
  font-size: 1.0em;  /* Zmen≈°eno z 1.1em */
  color: var(--text-color);
}

.truck-lanes {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 1px;
  background: var(--border-color);
  min-height: 180px;  /* Zmen≈°eno z 200px */
}

.truck-lane {
  background: var(--card-bg);
  padding: 8px;      /* Zmen≈°eno z 10px */
  min-height: 160px; /* Zmen≈°eno z 180px */
  border-right: 1px solid var(--border-color);
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center; /* Centrov√°n√≠ palet v lanes */
  position: relative;
}

.truck-lane:last-child {
  border-right: none;
}

.truck-lane.drag-over {
  background-color: rgba(13, 110, 253, 0.15) !important;
  border-color: #2196f3;
  box-shadow: inset 0 0 10px rgba(33, 150, 243, 0.2);
}

[data-theme="dark"] .truck-lane.drag-over {
  background-color: rgba(77, 171, 247, 0.15) !important;
}

.truck-lane.can-drop {
  background-color: rgba(0, 123, 255, 0.1);
  border: 2px dashed #007bff;
}

.truck-lane.unassigned {
  background: var(--bg-secondary);
  border: 2px dashed var(--text-muted);
  border-radius: 4px;
  margin-top: 10px;
}

.truck-lane.unassigned.drag-over {
  background-color: rgba(255, 193, 7, 0.15);
  border-color: #ffc107;
}

.pallet-box {
  display: inline-block;
  width: 70px;  /* Zmen≈°eno z 80px pro kompaktnost */
  height: 55px; 
  margin: 3px;  /* Zmen≈°eno z 5px */
  background: var(--card-bg);
  border: 2px solid #28a745;
  border-radius: 4px;
  text-align: center;
  cursor: grab;
  transition: all 0.3s ease;
  box-shadow: 0 1px 3px var(--shadow);
  position: relative;
  user-select: none;
}

.pallet-box:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 6px 16px var(--shadow);
  border-color: #20c997;
  z-index: 10;
}

.pallet-box:active {
  cursor: grabbing;
}

.pallet-box.dragging {
  opacity: 0.7;
  transform: rotate(8deg) scale(1.1);
  z-index: 1000;
  box-shadow: 0 8px 25px var(--shadow);
  border-color: #007bff;
  filter: brightness(1.1);
}

.pallet-box.ghost {
  opacity: 0.3;
  transform: scale(0.9);
  border-style: dashed;
}

.pallet-box.selected {
  border-color: #007bff !important;
  border-width: 3px !important;
  box-shadow: 0 0 15px rgba(0, 123, 255, 0.5) !important;
  z-index: 100 !important;
}

.pallet-length {
  background: #28a745;
  color: white;
  font-weight: bold;
  font-size: 0.9em;
  padding: 5px 2px;  /* V√≠ce paddingu */
  border-radius: 2px 2px 0 0;
  line-height: 1.1;
  height: 28px;      /* Definovan√° v√Ω≈°ka pro d√©lku sekci */
  display: flex;
  align-items: center;
  justify-content: center;
}

.pallet-lsa {
  font-weight: bold;
  font-size: 0.8em;  /* M√≠rnƒõ zvƒõt≈°eno z 0.75em */
  padding: 3px 2px;  /* V√≠ce paddingu */
  line-height: 1.1;  /* Lep≈°√≠ ≈ô√°dkov√°n√≠ */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  height: 25px;      /* Definovan√° v√Ω≈°ka pro LSA sekci */
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0 0 2px 2px; /* Zaoblen√≠ doln√≠ch roh≈Ø */
  color: white; /* B√≠l√Ω text pro v≈°echny LSA */
}

/* Dark mode vylep≈°en√≠ pro pallet text */
[data-theme="dark"] .pallet-lsa {
  color: #ffffff !important;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
}

[data-theme="dark"] .pallet-length {
  color: #ffffff !important;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
}

/* Drop zones pro p≈ôesn√© um√≠stƒõn√≠ - vylep≈°en√© */
.drop-zone {
  width: 100%;
  height: 20px;
  background: transparent;
  border: 2px dashed transparent;
  margin: 2px 0;
  transition: all 0.3s ease;
  border-radius: 6px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transform: scaleY(0.3);
}

.drop-zone:before {
  content: "‚¨á P≈ôet√°hnƒõte sem ‚¨á";
  font-size: 10px;
  color: #007bff;
  font-weight: bold;
  opacity: 0;
  transition: opacity 0.2s;
}

.drop-zone.drag-over {
  border-color: #007bff;
  background-color: rgba(0, 123, 255, 0.15);
  opacity: 1;
  transform: scaleY(1);
  height: 35px;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

[data-theme="dark"] .drop-zone.drag-over {
  background-color: rgba(77, 171, 247, 0.15);
  box-shadow: 0 2px 8px rgba(77, 171, 247, 0.3);
}

.drop-zone.drag-over:before {
  opacity: 1;
}

/* Zobrazit drop z√≥ny bƒõhem drag operace */
.dragging-active .drop-zone {
  opacity: 0.6;
  transform: scaleY(0.8);
  border-color: var(--border-color);
  background-color: var(--bg-secondary);
}

.drop-zone.top {
  margin-bottom: 5px;
}

.drop-zone.bottom {
  margin-top: 5px;
}

.unassigned-section .pallet-box {
  border-color: var(--text-muted);
}

.unassigned-section .pallet-length {
  background: var(--text-muted);
}

/* Animace pro lane totals */
.lane-total.updated {
  color: #28a745;
  transform: scale(1.1);
  transition: all 0.3s;
}

/* Animace pro vylep≈°en√© UX */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes slideIn {
  from { 
    opacity: 0; 
    transform: translateX(-50%) translateY(-20px); 
  }
  to { 
    opacity: 1; 
    transform: translateX(-50%) translateY(0); 
  }
}

@keyframes slideOut {
  from { 
    opacity: 1; 
    transform: translateX(-50%) translateY(0); 
  }
  to { 
    opacity: 0; 
    transform: translateX(-50%) translateY(-20px); 
  }
}

/* Loading spinner */
.loading-spinner {
  animation: pulse 1s infinite;
}

/* Touch support styly */
@media (hover: none) and (pointer: coarse) {
  .pallet-box {
    cursor: pointer;
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }
  
  .drop-zone {
    height: 30px;
    opacity: 0.3;
    border-color: #dee2e6;
    background-color: rgba(222, 226, 230, 0.1);
  }
  
  .drop-zone:before {
    content: "üì± Dotknƒõte se";
    font-size: 12px;
    opacity: 0.7;
  }
  
  .dragging-active .drop-zone {
    opacity: 1;
    transform: scaleY(1);
    border-color: #007bff;
    background-color: rgba(0, 123, 255, 0.2);
  }
}

/* Responzivn√≠ vylep≈°en√≠ */
@media (max-width: 768px) {
  .pallet-box {
    width: 65px;
    height: 50px;
    margin: 2px;
  }
  
  .pallet-length {
    height: 25px;
    font-size: 0.8em;
    padding: 3px 1px;
  }
  
  .pallet-lsa {
    height: 23px;
    font-size: 0.7em;
    padding: 2px 1px;
  }
  
  .drop-zone {
    height: 25px;
  }
  
  .drop-zone:before {
    font-size: 9px;
  }
  
  .truck-lane {
    padding: 6px;
    min-height: 140px;
  }
}

/* Kl√°vesov√© zkratky indik√°tor */
.keyboard-hint {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 1000;
  pointer-events: none;
}

.keyboard-hint.show {
  opacity: 1;
}

/* Lep≈°√≠ focus indik√°tory */
.pallet-box:focus {
  outline: 3px solid #007bff;
  outline-offset: 2px;
}

.drop-zone:focus {
  outline: 2px solid #28a745;
  outline-offset: 1px;
}

/* Pink theme enhancements */
[data-theme="pink"] .pallet-length {
  background: #e91e63;
}

[data-theme="pink"] .pallet-box {
  border-color: #f06292;
  box-shadow: 0 1px 3px rgba(233, 30, 99, 0.3);
}

[data-theme="pink"] .pallet-box:hover {
  border-color: #e91e63;
  box-shadow: 0 6px 16px rgba(233, 30, 99, 0.4);
}

[data-theme="pink"] .drop-zone.drag-over {
  border-color: #e91e63;
  background-color: rgba(233, 30, 99, 0.15);
  box-shadow: 0 2px 8px rgba(233, 30, 99, 0.3);
}

[data-theme="pink"] .truck-lane.drag-over {
  background-color: rgba(233, 30, 99, 0.1) !important;
  border-color: #e91e63;
  box-shadow: inset 0 0 10px rgba(233, 30, 99, 0.2);
}

/* Green theme enhancements */
[data-theme="green"] .pallet-length {
  background: #4caf50;
}

[data-theme="green"] .pallet-box {
  border-color: #66bb6a;
  box-shadow: 0 1px 3px rgba(76, 175, 80, 0.3);
}

[data-theme="green"] .pallet-box:hover {
  border-color: #4caf50;
  box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}

[data-theme="green"] .drop-zone.drag-over {
  border-color: #4caf50;
  background-color: rgba(76, 175, 80, 0.15);
  box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
}

[data-theme="green"] .truck-lane.drag-over {
  background-color: rgba(76, 175, 80, 0.1) !important;
  border-color: #4caf50;
  box-shadow: inset 0 0 10px rgba(76, 175, 80, 0.2);
}
</style>

<script>
// LSA Color Generator (stejn√Ω algoritmus jako na serveru)
function getLSAColor(lsaCode) {
    if (!lsaCode) return '#6c757d';
    
    // Hash LSA k√≥du pro konzistentn√≠ barvy
    let hash = 0;
    for (let i = 0; i < lsaCode.length; i++) {
        const char = lsaCode.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    
    // P≈ôevod na HSL pro lep≈°√≠ ƒçitelnost
    const hue = Math.abs(hash) % 360;
    const saturation = 70;  // 70% saturace
    const lightness = 45;   // 45% svƒõtlost
    
    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
}

// Inicializace barev LSA p≈ôi naƒçten√≠ str√°nky
document.addEventListener('DOMContentLoaded', function() {
    const lsaElements = document.querySelectorAll('[data-lsa]');
    lsaElements.forEach(element => {
        const lsaCode = element.getAttribute('data-lsa');
        if (element.classList.contains('pallet-lsa')) {
            element.style.backgroundColor = getLSAColor(lsaCode);
        }
    });
});

// Drag & Drop funkcionalita s vylep≈°en√Ωm UX
let draggedElement = null;
let originalParent = null;
let isActive = false;

function allowDrop(ev) {
    ev.preventDefault();
    const dropZone = ev.currentTarget;
    
    if (!dropZone.classList.contains('drag-over')) {
        dropZone.classList.add('drag-over');
        
        // P≈ôidat pulzuj√≠c√≠ animaci
        dropZone.style.animation = 'pulse 1s infinite';
    }
}

function drag(ev) {
    draggedElement = ev.target.closest('.pallet-box');
    originalParent = draggedElement.parentElement;
    
    // Aktivovat drag mode pro cel√Ω kontejner
    document.getElementById('truck-visualization').classList.add('dragging-active');
    
    draggedElement.classList.add('dragging');
    
    // Vytvo≈ôit ghost element
    const ghost = draggedElement.cloneNode(true);
    ghost.classList.add('ghost');
    ghost.classList.remove('dragging');
    originalParent.insertBefore(ghost, draggedElement.nextSibling);
    
    ev.dataTransfer.setData("text/plain", draggedElement.dataset.itemId);
    ev.dataTransfer.effectAllowed = "move";
    
    isActive = true;
}

function drop(ev) {
    ev.preventDefault();
    cleanupDragVisuals(ev.currentTarget);
    
    if (draggedElement && ev.currentTarget.classList.contains('truck-lane')) {
        const itemId = ev.dataTransfer.getData("text/plain");
        const newLane = ev.currentTarget.dataset.lane;
        
        // Vizu√°ln√≠ feedback p≈ôed API vol√°n√≠m
        showDropSuccess(ev.currentTarget);
        
        // P≈ôesun na konec lane s optimistick√Ωm UI
        movePallet(itemId, newLane, -1, true);
    }
    
    resetDragState();
}

function dropAtPosition(ev) {
    ev.preventDefault();
    cleanupDragVisuals(ev.currentTarget);
    
    if (draggedElement) {
        const itemId = ev.dataTransfer.getData("text/plain");
        const newLane = ev.currentTarget.dataset.lane;
        const position = parseInt(ev.currentTarget.dataset.position);
        
        // Vizu√°ln√≠ feedback
        showDropSuccess(ev.currentTarget);
        
        // P≈ôesun na konkr√©tn√≠ pozici s optimistick√Ωm UI
        movePallet(itemId, newLane, position, true);
    }
    
    resetDragState();
}

function showDropSuccess(element) {
    element.style.backgroundColor = '#d4edda';
    element.style.borderColor = '#28a745';
    setTimeout(() => {
        element.style.backgroundColor = '';
        element.style.borderColor = '';
    }, 1000);
}

function cleanupDragVisuals(currentTarget) {
    currentTarget.classList.remove('drag-over');
    currentTarget.style.animation = '';
}

function resetDragState() {
    if (draggedElement) {
        draggedElement.classList.remove('dragging');
        draggedElement = null;
    }
    
    // Odebrat ghost elements
    document.querySelectorAll('.ghost').forEach(ghost => ghost.remove());
    
    document.getElementById('truck-visualization').classList.remove('dragging-active');
    document.querySelectorAll('.truck-lane, .drop-zone').forEach(element => {
        element.classList.remove('drag-over', 'can-drop');
        element.style.animation = '';
    });
    
    isActive = false;
}

// Vylep≈°en√© event listeners
document.addEventListener('dragleave', function(ev) {
    if (ev.target.classList.contains('truck-lane') || ev.target.classList.contains('drop-zone')) {
        ev.target.classList.remove('drag-over');
        ev.target.style.animation = '';
    }
});

document.addEventListener('dragend', function(ev) {
    resetDragState();
});

// P≈ôid√°n√≠ hover efekt≈Ø a touch podpory
document.addEventListener('DOMContentLoaded', function() {
    const pallets = document.querySelectorAll('.pallet-box');
    const keyboardHint = createKeyboardHint();
    let selectedPallet = null;
    let touchStartTime = 0;
    let touchMoved = false;
    
    // Inicializace LSA barev a event listeners
    initializeLSAColors();
    initializePalletInteractions();
    initializeKeyboardSupport();
    initializeTouchSupport();
    initializeEmailButtons();
    
    function initializeEmailButtons() {
        // Email tlaƒç√≠tka
        document.addEventListener('click', function(e) {
            if (e.target.dataset.action === 'send-carrier') {
                const orderId = e.target.dataset.orderId;
                sendCarrierEmail(orderId);
            } else if (e.target.dataset.action === 'send-loading') {
                const orderId = e.target.dataset.orderId;
                sendLoadingEmail(orderId);
            }
        });
    }
    
    function initializeLSAColors() {
        const lsaElements = document.querySelectorAll('[data-lsa]');
        lsaElements.forEach(element => {
            const lsaCode = element.getAttribute('data-lsa');
            if (element.classList.contains('pallet-lsa')) {
                element.style.backgroundColor = getLSAColor(lsaCode);
            }
        });
    }
    
    function initializePalletInteractions() {
        pallets.forEach(pallet => {
            // Mouse events
            pallet.addEventListener('mouseenter', function() {
                if (!isActive) {
                    this.style.transform = 'translateY(-3px) scale(1.05)';
                    this.title = `LSA: ${this.dataset.lsa} | P≈ôet√°hnƒõte pro p≈ôem√≠stƒõn√≠ nebo pou≈æijte kl√°vesy (1,2,3)`;
                }
            });
            
            pallet.addEventListener('mouseleave', function() {
                if (!isActive && !this.classList.contains('selected')) {
                    this.style.transform = '';
                }
            });
            
            // Click selection pro kl√°vesnice
            pallet.addEventListener('click', function() {
                selectPallet(this);
            });
            
            // Touch events pro mobiln√≠ za≈ô√≠zen√≠
            pallet.addEventListener('touchstart', handleTouchStart);
            pallet.addEventListener('touchmove', handleTouchMove);
            pallet.addEventListener('touchend', handleTouchEnd);
            
            // P≈ô√≠stupnost
            pallet.setAttribute('tabindex', '0');
            pallet.setAttribute('role', 'button');
            pallet.setAttribute('aria-label', `Paleta ${pallet.dataset.lsa}, p≈ôesunuteln√°`);
        });
    }
    
    function initializeKeyboardSupport() {
        document.addEventListener('keydown', function(e) {
            if (selectedPallet) {
                keyboardHint.classList.add('show');
                
                if (e.key >= '1' && e.key <= '3') {
                    const targetLane = e.key;
                    const itemId = selectedPallet.dataset.itemId;
                    
                    // Vizu√°ln√≠ feedback
                    selectedPallet.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        movePallet(itemId, targetLane, -1, true);
                        deselectPallet();
                    }, 200);
                } else if (e.key === 'Escape') {
                    deselectPallet();
                } else if (e.key === '0') {
                    // P≈ôesun do nep≈ôi≈ôazen√Ωch
                    const itemId = selectedPallet.dataset.itemId;
                    movePallet(itemId, '0', -1, true);
                    deselectPallet();
                }
                
                setTimeout(() => keyboardHint.classList.remove('show'), 3000);
            }
        });
    }
    
    function initializeTouchSupport() {
        // Touch drag & drop
        document.querySelectorAll('.truck-lane, .drop-zone').forEach(zone => {
            zone.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.classList.add('can-drop');
            });
            
            zone.addEventListener('touchend', function(e) {
                e.preventDefault();
                this.classList.remove('can-drop');
                
                if (selectedPallet && this.classList.contains('drop-zone')) {
                    const itemId = selectedPallet.dataset.itemId;
                    const newLane = this.dataset.lane;
                    const position = parseInt(this.dataset.position);
                    
                    movePallet(itemId, newLane, position, true);
                    deselectPallet();
                }
            });
        });
    }
    
    function handleTouchStart(e) {
        touchStartTime = Date.now();
        touchMoved = false;
        
        // Dlouh√Ω dotek = v√Ωbƒõr
        setTimeout(() => {
            if (!touchMoved && selectedPallet !== this) {
                selectPallet(this);
                navigator.vibrate && navigator.vibrate(50); // Haptick√Ω feedback
            }
        }, 500);
    }
    
    function handleTouchMove(e) {
        touchMoved = true;
    }
    
    function handleTouchEnd(e) {
        const touchDuration = Date.now() - touchStartTime;
        
        if (!touchMoved && touchDuration < 500) {
            // Kr√°tk√Ω dotek = rychl√Ω v√Ωbƒõr
            selectPallet(this);
        }
    }
    
    function selectPallet(pallet) {
        // Deselect p≈ôedchoz√≠
        if (selectedPallet) {
            selectedPallet.classList.remove('selected');
            selectedPallet.style.border = '';
            selectedPallet.style.transform = '';
        }
        
        // Select nov√Ω
        selectedPallet = pallet;
        selectedPallet.classList.add('selected');
        selectedPallet.style.border = '3px solid #007bff';
        selectedPallet.style.transform = 'scale(1.1)';
        selectedPallet.style.zIndex = '100';
        
        // Zobrazit n√°povƒõdu
        keyboardHint.classList.add('show');
        setTimeout(() => keyboardHint.classList.remove('show'), 5000);
        
        // Zv√Ωraznit mo≈æn√© drop z√≥ny
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.style.opacity = '1';
            zone.style.transform = 'scaleY(1)';
        });
    }
    
    function deselectPallet() {
        if (selectedPallet) {
            selectedPallet.classList.remove('selected');
            selectedPallet.style.border = '';
            selectedPallet.style.transform = '';
            selectedPallet.style.zIndex = '';
            selectedPallet = null;
        }
        
        keyboardHint.classList.remove('show');
        
        // Skr√Ωt drop z√≥ny
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.style.opacity = '';
            zone.style.transform = '';
        });
    }
    
    function createKeyboardHint() {
        const hint = document.createElement('div');
        hint.className = 'keyboard-hint';
        hint.innerHTML = `
            üéØ <strong>Kl√°vesy:</strong><br>
            1, 2, 3 = P≈ôesun do Lane<br>
            0 = Nep≈ôi≈ôazen√©<br>
            ESC = Zru≈°it v√Ωbƒõr
        `;
        document.body.appendChild(hint);
        return hint;
    }
});

// Optimalizovan√Ω API endpoint pro p≈ôesun s lep≈°√≠ UX
function movePallet(itemId, newLane, position, optimistic = false) {
    // Loading indik√°tor
    const loadingSpinner = document.createElement('div');
    loadingSpinner.className = 'loading-spinner';
    loadingSpinner.innerHTML = '‚è≥';
    loadingSpinner.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #007bff; color: white; padding: 8px 12px; border-radius: 4px; z-index: 9999; font-size: 14px;';
    document.body.appendChild(loadingSpinner);
    
    // Optimistick√© UI - okam≈æitƒõ p≈ôesunout element
    if (optimistic && draggedElement) {
        const targetLane = document.querySelector(`[data-lane="${newLane}"]`);
        if (targetLane && targetLane.classList.contains('truck-lane')) {
            const clonedElement = draggedElement.cloneNode(true);
            clonedElement.classList.remove('dragging');
            clonedElement.style.opacity = '0.7';
            clonedElement.style.filter = 'grayscale(50%)';
            
            if (position === -1 || position >= targetLane.children.length) {
                targetLane.appendChild(clonedElement);
            } else {
                const dropZones = targetLane.querySelectorAll('.drop-zone');
                if (dropZones[position]) {
                    targetLane.insertBefore(clonedElement, dropZones[position]);
                }
            }
            
            // Skr√Ωt origin√°ln√≠ element
            draggedElement.style.opacity = '0.3';
        }
    }

    fetch('/move_pallet_position', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            item_id: itemId,
            new_lane: parseInt(newLane),
            position: position
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        document.body.removeChild(loadingSpinner);
        
        if (data.success) {
            // √öspƒõch - rychl√© obnoven√≠ pouze pot≈ôebn√Ωch ƒç√°st√≠
            updateLaneTotals(data.lane_totals);
            showSuccessMessage('Paleta √∫spƒõ≈°nƒõ p≈ôesunuta!');
            
            // Pln√© obnoven√≠ a≈æ po kr√°tk√© dobƒõ
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Nezn√°m√° chyba');
        }
    })
    .catch(error => {
        document.body.removeChild(loadingSpinner);
        console.error('Error:', error);
        
        // Fallback na star√Ω endpoint
        fetch('/move_pallet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                item_id: itemId,
                new_lane: parseInt(newLane)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage('Paleta p≈ôesunuta (fallback)');
                setTimeout(() => location.reload(), 1000);
            } else {
                showErrorMessage('Chyba p≈ôi p≈ôesunu: ' + (data.error || 'Nezn√°m√° chyba'));
                location.reload();
            }
        })
        .catch(fallbackError => {
            console.error('Fallback error:', fallbackError);
            showErrorMessage('Chyba p≈ôi p≈ôesunu palety. Str√°nka bude obnovena.');
            setTimeout(() => location.reload(), 2000);
        });
    });
}

function updateLaneTotals(laneTotals) {
    if (!laneTotals) return;
    
    Object.keys(laneTotals).forEach(lane => {
        const laneTotal = document.querySelector(`.lane-summary.lane-${lane} p strong`);
        if (laneTotal) {
            laneTotal.textContent = `${laneTotals[lane].toFixed(2)} m`;
            animateUpdate(laneTotal.parentElement);
        }
    });
}

function showSuccessMessage(message) {
    showMessage(message, 'success');
}

function showErrorMessage(message) {
    showMessage(message, 'error');
}

function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} message-popup`;
    messageDiv.innerHTML = `
        <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i>
        ${message}
    `;
    messageDiv.style.cssText = `
        position: fixed; 
        top: 20px; 
        left: 50%; 
        transform: translateX(-50%); 
        z-index: 9999; 
        min-width: 300px;
        text-align: center;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (messageDiv.parentElement) {
                document.body.removeChild(messageDiv);
            }
        }, 300);
    }, 3000);
}

// Animace pro aktualizovan√© hodnoty
function animateUpdate(element) {
    element.classList.add('updated');
    setTimeout(() => {
        element.classList.remove('updated');
    }, 1000);
}

// Email funkce
function sendCarrierEmail(orderId) {
    if (!confirm('Opravdu chcete odeslat email dopravci?')) return;
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Odes√≠l√°m...';
    button.disabled = true;
    
    fetch(`/send_carrier_email/${orderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(data.message);
        } else {
            showErrorMessage(data.error);
        }
    })
    .catch(error => {
        showErrorMessage('Chyba p≈ôi odes√≠l√°n√≠ emailu: ' + error);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function sendLoadingEmail(orderId) {
    if (!confirm('Opravdu chcete odeslat email na nakl√°dku?')) return;
    
    const button = event.target;
    const originalText = button.innerHTML;
    const additionalText = document.getElementById('additionalText').value;
    
    button.innerHTML = '‚è≥ Odes√≠l√°m...';
    button.disabled = true;
    
    fetch(`/send_loading_email/${orderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            additional_text: additionalText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(data.message);
            document.getElementById('additionalText').value = ''; // Vyƒçistit pole
        } else {
            showErrorMessage(data.error);
        }
    })
    .catch(error => {
        showErrorMessage('Chyba p≈ôi odes√≠l√°n√≠ emailu: ' + error);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// ===== NOV√â FUNKCE PRO KONTROLU NALO≈ΩEN√ùCH LSA =====

// Oznaƒçen√≠/odznaƒçen√≠ LSA jako nalo≈æen√©
function toggleLSALoaded(lsa, orderId, loaded) {
    const statusElement = document.getElementById(`status-${lsa}`);
    const checkbox = document.getElementById(`lsa-${lsa}`);
    
    // Vizu√°ln√≠ feedback
    statusElement.innerHTML = '<span class="badge bg-warning">‚è≥ Ukl√°d√°m...</span>';
    checkbox.disabled = true;
    
    fetch('/mark_lsa_loaded', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId,
            lsa: lsa,
            loaded: loaded
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Aktualizovat status badge
            const badgeClass = loaded ? 'bg-success' : 'bg-secondary';
            const badgeText = loaded ? '‚úÖ Nalo≈æeno' : 'Nezkontrolov√°no';
            statusElement.innerHTML = `<span class="badge ${badgeClass}">${badgeText}</span>`;
            
            // Aktualizovat celkov√© statistiky
            updateLoadingStatistics(orderId);
            
            showSuccessMessage(data.message);
        } else {
            // Vr√°tit checkbox do p≈Øvodn√≠ho stavu
            checkbox.checked = !loaded;
            statusElement.innerHTML = '<span class="badge bg-danger">‚ùå Chyba</span>';
            showErrorMessage(data.error);
        }
    })
    .catch(error => {
        // Vr√°tit checkbox do p≈Øvodn√≠ho stavu
        checkbox.checked = !loaded;
        statusElement.innerHTML = '<span class="badge bg-danger">‚ùå Chyba</span>';
        showErrorMessage('Chyba p≈ôi ukl√°d√°n√≠: ' + error);
    })
    .finally(() => {
        checkbox.disabled = false;
    });
}

// Odstranƒõn√≠ LSA z nakl√°dky
function removeLSAFromOrder(lsa, orderId) {
    if (!confirm(`Opravdu chcete odstranit cel√© LSA "${lsa}" z nakl√°dky?\n\nV≈°echny palety s t√≠mto LSA budou p≈ôesunuty do zak√°zky "Vy≈ôazen√© z nakl√°dky".`)) {
        return;
    }
    
    const row = document.querySelector(`tr[data-lsa="${lsa}"]`);
    if (row) {
        row.style.opacity = '0.5';
    }
    
    // Pou≈æijeme existuj√≠c√≠ formul√°≈ô pro odstranƒõn√≠ LSA
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/remove_lsa';
    form.style.display = 'none';
    
    const orderInput = document.createElement('input');
    orderInput.type = 'hidden';
    orderInput.name = 'order_id';
    orderInput.value = orderId;
    
    const lsaInput = document.createElement('input');
    lsaInput.type = 'hidden';
    lsaInput.name = 'lsa';
    lsaInput.value = lsa;
    
    form.appendChild(orderInput);
    form.appendChild(lsaInput);
    document.body.appendChild(form);
    form.submit();
}

// Vr√°cen√≠ v≈°ech nenalo≈æen√Ωch palet zpƒõt do fronty
function returnUnloadedItems(orderId) {
    const uncheckedBoxes = document.querySelectorAll('.lsa-checkbox:not(:checked)');
    const uncheckedLSAs = Array.from(uncheckedBoxes).map(cb => cb.dataset.lsa);
    
    if (uncheckedLSAs.length === 0) {
        showSuccessMessage('V≈°echny LSA jsou oznaƒçen√© jako nalo≈æen√©!');
        return;
    }
    
    if (!confirm(`Opravdu chcete vr√°tit ${uncheckedLSAs.length} neoznaƒçen√Ωch LSA zpƒõt do fronty?\n\nLSA k√≥dy: ${uncheckedLSAs.join(', ')}\n\nTyto palety budou p≈ôesunuty do zak√°zky "Vy≈ôazen√© z nakl√°dky".`)) {
        return;
    }
    
    const button = document.getElementById('return-unloaded-btn');
    button.disabled = true;
    button.innerHTML = '‚è≥ P≈ôesouv√°m...';
    
    fetch('/return_unloaded_lsa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(data.message);
            // Obnovit str√°nku po √∫spƒõ≈°n√©m p≈ôesunu
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showErrorMessage(data.error);
        }
    })
    .catch(error => {
        showErrorMessage('Chyba p≈ôi p≈ôesunu: ' + error);
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '‚Ü©Ô∏è Vr√°tit nenalo≈æen√©';
    });
}

// Aktualizace statistik nakl√°dky
function updateLoadingStatistics(orderId) {
    fetch(`/get_loading_status/${orderId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const overall = data.overall;
            
            // Aktualizovat ƒç√≠sla
            document.getElementById('loaded-count').textContent = overall.loaded;
            document.getElementById('pending-count').textContent = overall.total - overall.loaded;
            document.getElementById('completion-percentage').textContent = overall.percentage + '%';
            
            // Aktualizovat progress bar
            const progressBar = document.getElementById('overall-progress');
            progressBar.style.width = overall.percentage + '%';
            progressBar.setAttribute('aria-valuenow', overall.percentage);
            progressBar.textContent = overall.percentage + '%';
            
            // Zmƒõnit barvu podle dokonƒçen√≠
            progressBar.className = 'progress-bar progress-bar-striped';
            if (overall.percentage === 100) {
                progressBar.classList.add('bg-success');
            } else if (overall.percentage >= 75) {
                progressBar.classList.add('bg-info');
            } else if (overall.percentage >= 50) {
                progressBar.classList.add('bg-warning');
            } else {
                progressBar.classList.add('bg-danger');
            }
            
            // Aktualizovat "Oznaƒçit v≈°e" checkbox
            updateSelectAllCheckbox(overall.loaded, overall.total);
        }
    })
    .catch(error => {
        console.error('Chyba p≈ôi naƒç√≠t√°n√≠ statistik:', error);
    });
}

// Aktualizace "Oznaƒçit v≈°e" checkboxu
function updateSelectAllCheckbox(loadedCount, totalCount) {
    const selectAllCheckbox = document.getElementById('selectAllLSA');
    
    if (loadedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (loadedCount === totalCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// Oznaƒçit/odznaƒçit v≈°echny LSA
function toggleAllLSA() {
    const selectAllCheckbox = document.getElementById('selectAllLSA');
    const allCheckboxes = document.querySelectorAll('.lsa-checkbox');
    const shouldCheck = selectAllCheckbox.checked;
    
    // Potvrdit akci
    const action = shouldCheck ? 'oznaƒçit v≈°echny LSA jako nalo≈æen√©' : 'odznaƒçit v≈°echny LSA';
    if (!confirm(`Opravdu chcete ${action}?`)) {
        selectAllCheckbox.checked = !shouldCheck; // Vr√°tit zpƒõt
        return;
    }
    
    // Postupnƒõ oznaƒçit/odznaƒçit v≈°echny
    allCheckboxes.forEach((checkbox, index) => {
        setTimeout(() => {
            if (checkbox.checked !== shouldCheck) {
                checkbox.checked = shouldCheck;
                toggleLSALoaded(checkbox.dataset.lsa, checkbox.dataset.orderId, shouldCheck);
            }
        }, index * 200); // Delay pro lep≈°√≠ UX
    });
}

// Inicializace p≈ôi naƒçten√≠ str√°nky
document.addEventListener('DOMContentLoaded', function() {
    // ... existuj√≠c√≠ k√≥d ...
    
    // P≈ôidat event listener pro "Oznaƒçit v≈°e" checkbox
    const selectAllCheckbox = document.getElementById('selectAllLSA');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', toggleAllLSA);
        
        // Naƒç√≠st aktu√°ln√≠ statistiky
        const orderId = selectAllCheckbox.closest('[data-order-id]')?.dataset.orderId || 
                       document.querySelector('[data-order-id]')?.dataset.orderId;
        if (orderId) {
            updateLoadingStatistics(orderId);
        }
    }
    
    // Event listener pro import z LSA tabulky
    const importLSAFromTableBtn = document.getElementById('importLSAFromTableBtn');
    if (importLSAFromTableBtn) {
        importLSAFromTableBtn.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            importSelectedLSAFromTable(parseInt(orderId));
        });
    }
});

// === IMPORT DOSTUPN√ùCH LSA FUNKCIONALITA ===

let availableLSAData = {};
let selectedAvailableLSA = new Set();

// Naƒçten√≠ dostupn√Ωch LSA
function loadAvailableLSA(orderId) {
    const container = document.getElementById('availableLSAContainer');
    const button = document.getElementById('loadAvailableLSABtn');
    
    // Toggle zobrazen√≠
    if (container.style.display === 'none') {
        container.style.display = 'block';
        button.innerHTML = 'üîº Skr√Ωt dostupn√© LSA';
        
        // Naƒç√≠st data pokud je≈°tƒõ nejsou naƒçtena
        if (Object.keys(availableLSAData).length === 0) {
            fetchAvailableLSA(orderId);
        }
    } else {
        container.style.display = 'none';
        button.innerHTML = 'üîç Zobrazit dostupn√© LSA';
    }
}

// API vol√°n√≠ pro naƒçten√≠ dostupn√Ωch LSA
function fetchAvailableLSA(orderId) {
    const tbody = document.getElementById('availableLSATableBody');
    const noDataDiv = document.getElementById('noAvailableLSA');
    
    tbody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Naƒç√≠t√°m dostupn√© LSA...</td></tr>';
    
    fetch(`/get_available_lsa/${orderId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            availableLSAData = data.available_lsa;
            displayAvailableLSA();
            
            if (Object.keys(availableLSAData).length === 0) {
                tbody.style.display = 'none';
                noDataDiv.style.display = 'block';
            } else {
                tbody.style.display = '';
                noDataDiv.style.display = 'none';
            }
        } else {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Chyba: ${data.error}</td></tr>`;
        }
    })
    .catch(error => {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Chyba p≈ôi naƒç√≠t√°n√≠: ${error}</td></tr>`;
    });
}

// Zobrazen√≠ dostupn√Ωch LSA v tabulce
function displayAvailableLSA(filteredData = null) {
    const tbody = document.getElementById('availableLSATableBody');
    const dataToShow = filteredData || availableLSAData;
    
    if (Object.keys(dataToShow).length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">≈Ω√°dn√© LSA nenalezeny</td></tr>';
        return;
    }
    
    let html = '';
    
    Object.entries(dataToShow).forEach(([lsaCode, lsaData]) => {
        const lengthsText = Object.entries(lsaData.lengths)
            .map(([length, count]) => count > 1 ? `${length} (${count}ks)` : length)
            .join(', ');
        
        const sourcesText = lsaData.sources.slice(0, 2).join(', ') + 
                           (lsaData.sources.length > 2 ? '...' : '');
        
        html += `
            <tr data-lsa="${lsaCode}">
                <td>
                    <div class="form-check">
                        <input class="form-check-input available-lsa-checkbox" type="checkbox" 
                               data-lsa="${lsaCode}" 
                               onchange="toggleAvailableLSASelection('${lsaCode}')">
                    </div>
                </td>
                <td><strong>${lsaCode}</strong></td>
                <td><small>${lsaData.lsa_designation || ''}</small></td>
                <td><small>${lengthsText}</small></td>
                <td><span class="badge bg-primary">${lsaData.count}</span></td>
                <td><strong>${lsaData.total_weight.toFixed(1)}</strong></td>
                <td><small title="${lsaData.sources.join(', ')}">${sourcesText}</small></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Toggle v√Ωbƒõru konkr√©tn√≠ho LSA
function toggleAvailableLSASelection(lsaCode) {
    const checkbox = document.querySelector(`[data-lsa="${lsaCode}"].available-lsa-checkbox`);
    
    if (checkbox.checked) {
        selectedAvailableLSA.add(lsaCode);
    } else {
        selectedAvailableLSA.delete(lsaCode);
    }
    
    updateAvailableSelectionSummary();
    updateSelectAllAvailableCheckbox();
}

// Toggle v√Ωbƒõru v≈°ech dostupn√Ωch LSA
function toggleSelectAllAvailable() {
    const selectAllCheckbox = document.getElementById('selectAllAvailableLSA');
    const individualCheckboxes = document.querySelectorAll('.available-lsa-checkbox');
    
    selectedAvailableLSA.clear();
    
    individualCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        if (selectAllCheckbox.checked) {
            selectedAvailableLSA.add(checkbox.dataset.lsa);
        }
    });
    
    updateAvailableSelectionSummary();
}

// Aktualizace "Vybrat v≈°e" checkboxu
function updateSelectAllAvailableCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllAvailableLSA');
    const individualCheckboxes = document.querySelectorAll('.available-lsa-checkbox');
    const checkedCount = selectedAvailableLSA.size;
    const totalCount = individualCheckboxes.length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === totalCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// Aktualizace souhrnu v√Ωbƒõru
function updateAvailableSelectionSummary() {
    let totalPallets = 0;
    let totalWeight = 0;
    
    selectedAvailableLSA.forEach(lsaCode => {
        if (availableLSAData[lsaCode]) {
            totalPallets += availableLSAData[lsaCode].count;
            totalWeight += availableLSAData[lsaCode].total_weight;
        }
    });
    
    document.getElementById('selectedLSACount').textContent = selectedAvailableLSA.size;
    document.getElementById('selectedPalletCount').textContent = totalPallets;
    document.getElementById('selectedTotalWeight').textContent = totalWeight.toFixed(1);
    
    // Aktivace/deaktivace import tlaƒç√≠tka
    const importBtn = document.getElementById('importLSABtn');
    importBtn.disabled = selectedAvailableLSA.size === 0;
}

// Filtrov√°n√≠ dostupn√Ωch LSA
function filterAvailableLSA() {
    const searchTerm = document.getElementById('lsaSearchInput').value.toLowerCase();
    
    if (searchTerm === '') {
        displayAvailableLSA();
        return;
    }
    
    const filteredData = {};
    
    Object.entries(availableLSAData).forEach(([lsaCode, lsaData]) => {
        const lsaMatches = lsaCode.toLowerCase().includes(searchTerm);
        const designationMatches = (lsaData.lsa_designation || '').toLowerCase().includes(searchTerm);
        const sourceMatches = lsaData.sources.some(source => source.toLowerCase().includes(searchTerm));
        const textMatches = lsaData.items.some(item => 
            (item.pallet_text || '').toLowerCase().includes(searchTerm)
        );
        
        if (lsaMatches || designationMatches || sourceMatches || textMatches) {
            filteredData[lsaCode] = lsaData;
        }
    });
    
    displayAvailableLSA(filteredData);
}

// Import vybran√Ωch LSA
function importSelectedLSA(orderId) {
    if (selectedAvailableLSA.size === 0) {
        showErrorMessage('Nebyla vybr√°na ≈æ√°dn√° LSA');
        return;
    }
    
    // Z√≠sk√°me ID v≈°ech item pro vybran√© LSA
    const selectedItemIds = [];
    selectedAvailableLSA.forEach(lsaCode => {
        if (availableLSAData[lsaCode]) {
            availableLSAData[lsaCode].items.forEach(item => {
                selectedItemIds.push(item.item_id);
            });
        }
    });
    
    if (!confirm(`Opravdu chcete importovat ${selectedAvailableLSA.size} LSA (${selectedItemIds.length} palet) do t√©to zak√°zky?`)) {
        return;
    }
    
    const importBtn = document.getElementById('importLSABtn');
    const originalText = importBtn.innerHTML;
    importBtn.disabled = true;
    importBtn.innerHTML = '‚è≥ Importuji...';
    
    fetch('/import_lsa_to_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_order_id: orderId,
            selected_items: selectedItemIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(data.message);
            
            // Reset stavu
            selectedAvailableLSA.clear();
            availableLSAData = {};
            
            // Schovat kontejner
            document.getElementById('availableLSAContainer').style.display = 'none';
            document.getElementById('loadAvailableLSABtn').innerHTML = 'üîç Zobrazit dostupn√© LSA';
            
            // Obnovit str√°nku po √∫spƒõ≈°n√©m importu
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showErrorMessage(data.error);
        }
    })
    .catch(error => {
        showErrorMessage('Chyba p≈ôi importu: ' + error);
    })
    .finally(() => {
        importBtn.disabled = false;
        importBtn.innerHTML = originalText;
    });
}

// Funkce pro maz√°n√≠ aktu√°ln√≠ zak√°zky
function deleteCurrentOrder(orderId, orderName) {
    if (!orderId) {
        showErrorMessage('Chyba: ID zak√°zky nenalezeno');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è POZOR: Opravdu chcete smazat zak√°zku "${orderName}"?\n\n‚ùå Tato akce je NEVRATN√Å!\n\n‚úÖ Zak√°zka bude smaz√°na pouze pokud neobsahuje ≈æ√°dn√© palety.\n\nPokraƒçovat?`)) {
        return;
    }
    
    // Najdeme tlaƒç√≠tko pro loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '‚è≥ Maz√°n√≠...';
    
    fetch(`/delete_order/${orderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Zobrazit success zpr√°vu
            showSuccessMessage(data.message);
            
            // P≈ôesmƒõrovat na seznam zak√°zek po √∫spƒõ≈°n√©m smaz√°n√≠
            setTimeout(() => {
                window.location.href = '/loading_orders';
            }, 2000);
        } else {
            // Zobrazit error zpr√°vu
            showErrorMessage(data.error);
            
            // Obnovit tlaƒç√≠tko
            button.disabled = false;
            button.innerHTML = originalText;
        }
    })
    .catch(error => {
        showErrorMessage('Chyba p≈ôi maz√°n√≠ zak√°zky: ' + error);
        
        // Obnovit tlaƒç√≠tko
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

</script>

{% endblock %}
